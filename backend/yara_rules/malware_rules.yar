/*
    YARA Rules for Malware Detection
    RakshanetrA Security System
    
    These rules detect common malware patterns and suspicious indicators
*/

rule Suspicious_Executable_Packed
{
    meta:
        description = "Detects packed or obfuscated executables"
        severity = "high"
        category = "packer"
    
    strings:
        $upx = "UPX!" ascii
        $aspack = "aspack" nocase
        $themida = "Themida" nocase
        $vmprotect = "VMProtect" nocase
        $enigma = "Enigma" nocase
    
    condition:
        any of them
}

rule Suspicious_Network_Activity
{
    meta:
        description = "Detects common malware network patterns"
        severity = "medium"
        category = "network"
    
    strings:
        $c2_1 = "cmd.exe" nocase
        $c2_2 = "powershell" nocase
        $c2_3 = "wget" nocase
        $c2_4 = "curl" nocase
        $url_1 = /https?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/ ascii
        $url_2 = /.onion/ nocase
        $port_scan = "nmap" nocase
    
    condition:
        2 of them
}

rule Ransomware_Indicators
{
    meta:
        description = "Detects potential ransomware behavior patterns"
        severity = "critical"
        category = "ransomware"
    
    strings:
        $encrypt_1 = "AES" nocase
        $encrypt_2 = "RSA" nocase
        $encrypt_3 = "encrypt" nocase
        $bitcoin = "bitcoin" nocase
        $wallet = "wallet" nocase
        $ransom_1 = "ransom" nocase
        $ransom_2 = "decrypt" nocase
        $ransom_3 = "payment" nocase
        $file_ext = ".locked" nocase
        $readme = "README" nocase
    
    condition:
        ($encrypt_1 or $encrypt_2 or $encrypt_3) and
        ($bitcoin or $wallet) and
        ($ransom_1 or $ransom_2 or $ransom_3)
}

rule Keylogger_Indicators
{
    meta:
        description = "Detects keylogger patterns"
        severity = "high"
        category = "spyware"
    
    strings:
        $key_1 = "GetAsyncKeyState" ascii
        $key_2 = "GetKeyboardState" ascii
        $key_3 = "SetWindowsHookEx" ascii
        $log_1 = "keylog" nocase
        $log_2 = "keystroke" nocase
    
    condition:
        any of them
}

rule Trojan_Indicators
{
    meta:
        description = "Detects common trojan patterns"
        severity = "high"
        category = "trojan"
    
    strings:
        $backdoor_1 = "backdoor" nocase
        $backdoor_2 = "shell" nocase
        $registry = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii
        $persistence = "schtasks" nocase
        $remote_1 = "TeamViewer" nocase
        $remote_2 = "AnyDesk" nocase
    
    condition:
        2 of them
}

rule Phishing_Document
{
    meta:
        description = "Detects potential phishing documents"
        severity = "medium"
        category = "phishing"
    
    strings:
        $macro_1 = "Auto_Open" nocase
        $macro_2 = "AutoOpen" nocase
        $macro_3 = "Document_Open" nocase
        $macro_4 = "Workbook_Open" nocase
        $vba_1 = "CreateObject" nocase
        $vba_2 = "Shell" nocase
        $vba_3 = "WScript" nocase
        $url = /https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}/ ascii
    
    condition:
        any of ($macro_*) and any of ($vba_*)
}

rule Suspicious_PDF
{
    meta:
        description = "Detects suspicious PDF with embedded scripts"
        severity = "medium"
        category = "pdf"
    
    strings:
        $pdf_header = "%PDF" ascii
        $js_1 = "/JavaScript" ascii
        $js_2 = "/JS" ascii
        $launch = "/Launch" ascii
        $openaction = "/OpenAction" ascii
        $aa = "/AA" ascii
    
    condition:
        $pdf_header and (any of ($js_*) or $launch or $openaction or $aa)
}

rule Cryptocurrency_Miner
{
    meta:
        description = "Detects cryptocurrency mining software"
        severity = "medium"
        category = "miner"
    
    strings:
        $stratum = "stratum+tcp://" ascii
        $pool_1 = "pool" nocase
        $pool_2 = "mining" nocase
        $crypto_1 = "monero" nocase
        $crypto_2 = "ethereum" nocase
        $crypto_3 = "bitcoin" nocase
        $miner_1 = "xmrig" nocase
        $miner_2 = "ethminer" nocase
    
    condition:
        $stratum or (any of ($pool_*) and any of ($crypto_*))
}

rule Data_Exfiltration
{
    meta:
        description = "Detects potential data exfiltration patterns"
        severity = "high"
        category = "exfiltration"
    
    strings:
        $ftp = "ftp://" nocase
        $sftp = "sftp://" nocase
        $upload = "upload" nocase
        $send = "send" nocase
        $exfil = "exfil" nocase
        $zip = "zip" nocase
        $rar = "rar" nocase
        $compress = "compress" nocase
    
    condition:
        ($ftp or $sftp) and (($upload or $send or $exfil) and ($zip or $rar or $compress))
}

rule Indian_Army_Targeted_Attack
{
    meta:
        description = "Detects content specifically targeting Indian defense personnel"
        severity = "critical"
        category = "apt"
    
    strings:
        $army_1 = "Indian Army" nocase
        $army_2 = "भारतीय सेना" nocase
        $army_3 = "Ministry of Defence" nocase
        $army_4 = "रक्षा मंत्रालय" nocase
        $target_1 = "soldier" nocase
        $target_2 = "officer" nocase
        $target_3 = "credentials" nocase
        $target_4 = "password" nocase
        $social_1 = "WhatsApp" nocase
        $social_2 = "Telegram" nocase
    
    condition:
        any of ($army_*) and any of ($target_*) and any of ($social_*)
}
